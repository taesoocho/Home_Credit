# 캐글 Home Credit Default Risk 분석 

- 문제에 관한 자세한 내용은 아래 링크를 통해 알 수 있습니다.  
https://www.kaggle.com/competitions/home-credit-default-risk

- 해당 README에서는 분석한 결과를 ppt와 함께 설명하고자 합니다.  
- 분석에 사용된 코드들은 하단에 링크로 표기합니다.  

![슬라이드1](https://user-images.githubusercontent.com/50400392/179346557-307a281c-4b53-42f7-8d99-6d292cb98612.PNG)

Home Credit은 1997년 체코에서 설립되었으며 네덜란드에 본사를 두고 있는 국제 비은행 금융기관입니다.  
9개국에서 운영되고 있으며 신용 기록이 거의 또는 전혀 없는 사람들에게 주로 대출 서비스를 제공하고 있습니다.  
Home Credit은 고객 데이터를 이용하여 대출을 제공하였을 때, 해당 고객이 연체할 가능성을 예측하는 신용평가 모델을 만들고자 합니다.  
캐글에 데이터를 제공하고 더 좋은 신용평가 모델을 만드는 방법을 얻고자 했습니다.  
아래의 슬라이드는 캐글에서 'Home Credit'사가 데이터를 제공하며 정의한 문제를 나타냅니다.

![슬라이드2](https://user-images.githubusercontent.com/50400392/179346578-a20dba27-292c-4a16-bc92-011d8d74befa.PNG)

'Home Credit Default Risk'의 전체 데이터 구조는 아래와 같습니다.
- train/test 데이터로 사용되는 application 데이터는 홈 크레딧에 대출 신청 당시 작성한 내용을 알 수 있습니다.
- bureau 데이터를 통해서 과거에 다른 금융기관과의 신용거래 내역을 알 수 있습니다.
- previous 데이터에는 과거 홈 크레딧에서 대출 기록을 알 수 있습니다.

![슬라이드3](https://user-images.githubusercontent.com/50400392/179346579-a9f82eea-04ab-4e9f-90c3-ffc552a004c0.PNG)

위에서 살펴본 데이터 구조에 맞게 데이터들을 통합하는 과정이 필요합니다.  
데이터 구조는 부모 테이블의 기본키가 자식 테이블의 기본키에 포함되는 식별 가능한 경우로 이루어져 있습니다.  
기본키를 기준으로 부모 테이블과 자식 테이블은 1대다 관계를 가지고 있기 때문에,  
자식 테이블을 부모 테이블과 통합하려면 자식 테이블의 기본키가 부모 테이블과 동일하게 하나의 로우(Row)로 그룹화가 필요합니다.  

따라서 다음과 같은 방식으로 통합 프로세스가 진행됩니다. 

1. 자식 테이블을 기본키를 기준으로 그룹화를 진행합니다.
2. 자식 테이블의 그룹화를 통해 **범주형** 데이터들은 최신값과 최빈값을 추출하고 **수치형** 데이터는 평균값, 중앙값, 표준편차값, 최신값을 추출합니다.
3. 기본키를 기준으로 통합하여 하나의 데이터 셋으로 만듭니다.
4. 가장 하단의 테이블부터 부모 테이블(application.csv)까지 이 과정을 반복합니다.

예를 들어 bureau.csv와 bureau_balance.csv의 통합 과정은 아래와 같습니다.  

![슬라이드4](https://user-images.githubusercontent.com/50400392/179346581-63e66baf-be76-4a83-9276-57bff4b4e835.PNG)

먼저 위와 같이 기본키를 기준으로 1대다 관계를 확인합니다.  

![슬라이드5](https://user-images.githubusercontent.com/50400392/179346582-29a8bdeb-b240-4764-9a9d-9c74ea5eb41b.PNG)

기본키인 SK_ID_BUREAU를 기준으로 여러개로 이루어져 있는 데이터들을 그룹화하여 하나의 데이터로 만들어줍니다.  
MONTH_BALANCE 변수는 수치형 데이터이므로 그룹화하여 평균값, 중앙값, 표준편차값, 최신값을 만들어 우측 사진과 같이 변경합니다.  

![슬라이드6](https://user-images.githubusercontent.com/50400392/179346583-5b91f16c-dfa5-4173-af3a-81fb15eeb615.PNG)

전처리를 통해 bureau.scv와 bureau_balnce.csv의 기본키들이 하나의 데이터로 변환되었으므로 기본키를 기준으로 하나의 데이터 셋으로 변경합니다.

### EDA (탐색적 데이터 분석)

해당 과정에서는 결측치, 이상치를 분석하고 필요한 경우, 전처리를 실시하였으며 연체율을 기준으로 특이점이 있는 범주형, 연속형 데이터를 시각화하였습니다.

![슬라이드7](https://user-images.githubusercontent.com/50400392/179346585-b536ebe2-fd86-4efd-82cf-caee3f400da0.PNG)

결측치 시각화에서는 결측치를 가진 변수의 비율이 55%라는 높은 결측치를 가진 데이터 셋임을 관찰할 수 있었습니다.  
머신러닝에 주로 사용되는 'sklearn'의 머신러닝 모델을 사용하기 위해서는 모든 결측치를 처리하여야 모델링이 가능합니다.
하지만 결측치를 처리하는 과정은 금융과 관련된 도메인 지식과 데이터를 만들고 추출할 때의 정보가 필요하지만,  
현재 Data Description에서는 충분한 정보를 얻을 수 없습니다.  

따라서 결측치를 내부적으로 처리해주는 동시에 높은 성능을 보이는 머신러닝 모델인 'Light Gradient Boosting'을 사용하였으며  
결측치를 따로 전처리하지는 않았습니다.

![슬라이드8](https://user-images.githubusercontent.com/50400392/179346586-5750f3c6-0a2e-4e73-9ad0-a28ac346e862.PNG)

통계치 분석을 통해 범주형 데이터들 중 2개의 변수에서 이상치를 확인하였습니다.  
먼저 CODE_GENDER(고객의 성별) 변수에서는 소수의 데이터가 성별을 알 수 없는 XNA으로 표기되어 있습니다.  
일반적인 머신러닝 모델을 생성하기 위해서는 해당 데이터를 삭제하고 진행해야 하지만  
train과 test 데이터 둘 다 XNA를 포함하고 있어서 이를 생략하였습니다.  

DAYS_EMPLOYED(고객의 근무일수) 변수에는 365243이라는 이상치가 발견되어 NULL로 전처리를 진행하였습니다.

![슬라이드9](https://user-images.githubusercontent.com/50400392/179346587-a5361718-df3b-439e-95fa-80224af12a16.PNG)

연속형 변수에서는 AGE(고객의 나이) 변수에서 연체 고객과 그렇지 않은 고객의 분포에 차이를 보였습니다.  

![슬라이드10](https://user-images.githubusercontent.com/50400392/179346589-2aa4d56f-ee1d-465d-b50b-3dc2a6fd7a28.PNG)

변수들 중 흥미로운 변수 2가지가 관찰되었습니다.  
1. Home Credit을 이용하는 고객들은 여자 고객이 남자 고객에 비해 약 33% 더 많았으나, 연체 고객은 남자 고객이 더 많았습니다.
2. 고객들의 최종 학력은 정상적으로 고등학교와 대학교를 졸업한 고객보다 그렇지 않은 고객의 연체율이 더 높았습니다.

### 데이터 가공 및 모델링

![슬라이드11](https://user-images.githubusercontent.com/50400392/179346590-53cf9dea-6965-42ef-909a-bad4b1732ac7.PNG)

데이터 셋에는 포함되어 있지 않지만 신용평가 모델 생성에 필요하다고 판단되는 4개의 변수를 생성하여 추가하였습니다.  
고객이 기존에 가지고 있는 여유 자금, 소득 대비 대출 크기는 얼마나 되는지, 대출을 갚아야 하는 기간, 나이 대비 근무일수를 생성하였습니다.  

![슬라이드12](https://user-images.githubusercontent.com/50400392/179346592-22b79751-eb24-4052-8ebe-7bb805815363.PNG)

신용평가 예측 모델링은 결측치가 많은 데이터 셋이므로 'Light Gradient Boosting' (lgb)를 사용하였습니다.  

평가 지표의 경우, Home Credit이 지정한 Roc 곡선을 사용하였습니다.  
Roc 곡선은 민감도와 특이도를 사용해 만든 곡선으로 민감도는 실제 양성 중 맞춘 양성의 비율, 특이도는 실제 음성 중 맞춘 음성의 비율입니다.  
민감도와 특이도를 신용 평가를 예측하는 모델에 적용한다면 다음과 같습니다. 고객의 상환 능력을 평가하여 대출 여부를 가리는 모델인 만큼, 예측의 정확성은 높을수록 좋습니다. 

여기서 정확성은 실제로 상환 능력이 되는 고객(양성)은 대출을 해주고(양성), 그렇지 않은 고객(음성)에게는 대출을 해주지 않는 것(음성) 모두를 충족해야 합니다.  
만약에 상환 능력이 되는 고객(양성)에게 대출을 해주지 않는다면(음성) 금융 관련 회사의 수익을 줄어들고, 상환 능력이 없는 고객(음성)에게 대출을 해준다면(양성) 연체를 통해 회사에 위험 부담이 커지게 됩니다.  
따라서 양성 판정을 제대로 내리는 것만 생각하는 것이 아니라 음성 판정도 제대로 내려야 하기 때문에 Home Credit은 Roc 곡선을 평가 지표로 사용하는 것으로 생각됩니다.  

### 모델링 결과

![슬라이드13](https://user-images.githubusercontent.com/50400392/179346593-dff3da88-9e5b-4c8a-a438-705a50b87026.PNG)

모델은 총 4개로 구분하여 실험하였습니다.  
1. 메인 데이터 셋인 application 데이터만 사용한 경우
2. 1번에 도메인 지식을 활용하여 피처 엔지니어링을 진행한 경우
3. 2번에 개인신용평가기관에 기록된 과거 타 금융기관과 신용거래 내역(bureau)을 더한 경우
4. 3번에 과거 Home Credit에서 신용거래한 내역(previous)을 추가한 경우

피처 엔지니어링이나 데이터를 추가할 경우, 예측 모델이 더욱 고도화 되는 것을 알 수 있습니다.  
도메인 지식을 활용한 피처 엔지니어링이 고도화에 가장 크게 영향을 미쳤습니다.  
데이터는 추가적인 수집이 어려운 경우가 많거나 많은 비용이 사용될 수 있는 단점이 존재하지만 도메인 지식을 활용하여 엔지니어링을 하는 것은 데이터 분석가가 회사 내의 신용 평가 프로세스를 익히고 금융 서비스를 이해할수록 모델을 더욱 고도화시킬 수 있을 것으로 보입니다.

![슬라이드14](https://user-images.githubusercontent.com/50400392/179346596-7e395733-3193-47ad-a39c-53d46bc9ce63.PNG)

마지막으로 생성된 모델로 데이터의 변수들을 평가하는 변수 중요도 분석을 진행하였습니다.  

![슬라이드15](https://user-images.githubusercontent.com/50400392/179346597-ba10df03-e7e5-4394-89af-200eba7cec6d.PNG)

![슬라이드16](https://user-images.githubusercontent.com/50400392/179346576-d8bb66c3-4cab-4d70-8d71-f532c60b9fee.PNG)
